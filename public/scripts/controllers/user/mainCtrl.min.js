/*! collection-application 2017-06-08 */

"use strict";angular.module("collectionApp").controller("MainCtrl",["$scope","$location","Auth","$timeout","$rootScope","User","$interval","$window",function(a,e,t,o,i,n,s,d){a.checkSession=function(){if(t.isLoggedIn()){a.checkingSession=!0;var e=s(function(){var a=d.localStorage.getItem("token");if(null===a)s.cancel(e);else{self.parseJwt=function(a){var e=a.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(d.atob(e))};var t=self.parseJwt(a),o=Math.floor(Date.now()/1e3);t.exp-o<=0&&(r("sm"),s.cancel(e))}},6e4)}},a.checkSession(),a.items=["item1","item2","item3"];var r=function(t){$modal.open({template:'<div class="modal-content"><div class="modal-header"><button ng-hide="hideButton" type="button" ng-click="endSession();" class="close" data-dismiss="modal">&times;</button>\x3c!-- Modal Header --\x3e<h4 class="modal-title">{{modalHeader}}</h4></div>\x3c!-- Modal Body --\x3e<div class="modal-body"><p>{{modalBody}}</p><div ng-show="hideButton" class="dizzy-gillespie"></div></div><div class="modal-footer">\x3c!-- Modal Yes & No Buttons --\x3e<button type="button" ng-hide="hideButton" ng-click="endSession();" class="btn btn-danger" data-dismiss="modal">OK</button></div></div>',controller:function(a,t,i){a.choiceMade=!1,a.modalHeader="Timeout Warning",a.modalBody="Your session will please Login again",o(function(){a.choiceMade||(s(),n())},4e3),a.renewSession=function(){a.choiceMade=!0,n()},a.endSession=function(){a.choiceMade=!0,s(),n()};var n=function(){t.close()},s=function(){i.logout(),o(function(){e.path("/login")},2e3)}},size:t,resolve:{items:function(){return a.items}}})};a.profileData={},i.$on("$stateChangeStart",function(){a.checkingSession||a.checkSession(),t.isLoggedIn()?t.getUser().then(function(e){a.profileData.user_name=e.data.user_name,a.profileData.email=e.data.email,n.getPermission().then(function(e){a.userdata=e.data.data,void 0!=e.data.data&&(a.profileData.permission=e.data.data.permission,a.profileData.first_Name=e.data.data.first_name,a.profileData.last_Name=e.data.data.last_name,a.profileData.userImage=e.data.data.user_img,a.profileData.user_id=e.data.data._id,a.profileData.contact_no_1=e.data.data.contact_no_1,a.profileData.contact_no_2=e.data.data.contact_no_2,a.profileData.address=e.data.data.address,a.profileData.country=e.data.data.country,a.profileData.state=e.data.data.state,a.profileData.city=e.data.data.city,"Admin"!==e.data.data.permission&&"User"!==e.data.data.permission||("Admin"===e.data.data.permission?(a.authorized=!0,a.user=!1):"Partner"===e.data.data.permission&&(a.authorized=!1,a.user=!0)))})}):console.log("user is logout!")}),a.submit=function(i){t.login(a.loginData).then(function(t){a.errorMsg=!1,a.expired=!1,t.data.success?(a.successMsg=t.data.message+"...Redircting",o(function(){e.path("/dashboard/home")},2e3)):t.data.expired?(a.expired=!0,a.errorMsg=t.data.message):(a.errorMsg=t.data.message,a.loginData={})})},a.logout=function(){t.logout(),o(function(){e.path("/login")},1e3)}}]);